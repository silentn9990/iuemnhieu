// Performance optimization: Remove preload class after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.remove('preload');
        });

        // Optimized particle system
        class ParticleSystem {
            constructor() {
                this.particles = [];
                this.maxParticles = 50;
                this.isActive = true;
            }

            createSparkle() {
                if (!this.isActive || this.particles.length >= this.maxParticles) return;
                
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.width = sparkle.style.height = (Math.random() * 4 + 2) + 'px';
                sparkle.style.animationDuration = (Math.random() * 3 + 2) + 's';
                sparkle.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(sparkle);
                
                this.particles.push(sparkle);
                
                setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.remove();
                        this.particles = this.particles.filter(p => p !== sparkle);
                    }
                }, 5000);
            }

            createFlower() {
                if (!this.isActive || this.particles.length >= this.maxParticles) return;
                
                const flower = document.createElement('div');
                flower.className = 'flower';
                flower.innerHTML = flowers[Math.floor(Math.random() * flowers.length)];
                flower.style.left = Math.random() * 100 + '%';
                flower.style.animationDuration = (Math.random() * 4 + 3) + 's';
                flower.style.fontSize = (Math.random() * 15 + 20) + 'px';
                flower.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(flower);
                
                this.particles.push(flower);
                
                setTimeout(() => {
                    if (flower.parentNode) {
                        flower.remove();
                        this.particles = this.particles.filter(p => p !== flower);
                    }
                }, 7000);
            }

            pause() {
                this.isActive = false;
                this.particles.forEach(particle => {
                    particle.style.animationPlayState = 'paused';
                });
            }

            resume() {
                this.isActive = true;
                this.particles.forEach(particle => {
                    particle.style.animationPlayState = 'running';
                });
            }
        }

        // Initialize particle system
        const particleSystem = new ParticleSystem();

        // Optimized intervals - Gi·∫£m t·∫ßn su·∫•t ƒë·ªÉ tr√°nh rung l·∫Øc
        const sparkleInterval = setInterval(() => particleSystem.createSparkle(), 1500); // T·ª´ 500ms l√™n 1500ms
        const flowerInterval = setInterval(() => particleSystem.createFlower(), 2000); // T·ª´ 800ms l√™n 2000ms

        // Calculator functionality
        const display = document.getElementById('display');
        const calculatorScreen = document.getElementById('calculatorScreen');
        const birthdayScreen = document.getElementById('birthdayScreen');

        // TH√äM: Flag ƒë·ªÉ tr√°nh double input
        let isButtonClick = false;

        function appendToDisplay(value) {
            if (display.value.length < 8) {
                isButtonClick = true; // ƒê√°nh d·∫•u l√† button click
                display.value += value;
                // createKeyEffect(); // T·∫Øt ƒë·ªÉ tr√°nh rung l·∫Øc
                
                // Reset flag sau 100ms
                setTimeout(() => {
                    isButtonClick = false;
                }, 100);
            }
        }

        function clearDisplay() {
            display.value = '';
            // createKeyEffect(); // T·∫Øt ƒë·ªÉ tr√°nh rung l·∫Øc
        }

        function deleteLast() {
            display.value = display.value.slice(0, -1);
            // createKeyEffect(); // T·∫Øt ƒë·ªÉ tr√°nh rung l·∫Øc
        }

        // Enhanced keyboard support - S·ª¨A ƒê·ªîI
        document.addEventListener('keydown', function(event) {
            if (calculatorScreen.style.display === 'none') return; // Ch·ªâ cho nh·∫≠p khi calculator ƒëang hi·ªán
            
            // TH√äM: Ki·ªÉm tra n·∫øu ƒëang trong button click th√¨ b·ªè qua keyboard
            if (isButtonClick) {
                event.preventDefault();
                return;
            }

            const key = event.key;

            if (key >= '0' && key <= '9') {
                event.preventDefault(); // NgƒÉn input m·∫∑c ƒë·ªãnh
                appendToDisplay(key);
            } else if (key === 'Enter') {
                event.preventDefault();
                checkPassword();
            } else if (key === 'Escape') {
                event.preventDefault();
                clearDisplay();
            } else if (key === 'Backspace') {
                event.preventDefault();
                deleteLast();
            }
        });

        // TH√äM: NgƒÉn input tr·ª±c ti·∫øp v√†o √¥ input
        display.addEventListener('input', function(event) {
            if (!isButtonClick) {
                // N·∫øu kh√¥ng ph·∫£i t·ª´ button click th√¨ prevent
                event.preventDefault();
                // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
                const currentValue = event.target.value;
                if (currentValue.length > 0) {
                    event.target.value = currentValue.slice(0, -1);
                }
            }
        });

        // TH√äM: NgƒÉn paste
        display.addEventListener('paste', function(event) {
            event.preventDefault();
        });

        // TH√äM: NgƒÉn keypress tr·ª±c ti·∫øp
        display.addEventListener('keypress', function(event) {
            if (!isButtonClick) {
                event.preventDefault();
            }
        });

        function createKeyEffect(val) {
            // T·∫Øt ƒë·ªÉ tr√°nh rung l·∫Øc
            return;
            // T√¨m ƒë√∫ng n√∫t v·ª´a b·∫•m (theo s·ªë)
            const btns = document.querySelectorAll('.btn-number');
            btns.forEach(btn => {
                if (btn.textContent === val) {
                    btn.classList.remove('effect');
                    void btn.offsetWidth; // trigger reflow
                    btn.classList.add('effect');
                    setTimeout(() => btn.classList.remove('effect'), 350);
                }
            });
        }

        function typeBirthdayLines(lines, element, done) {
            element.innerHTML = '';
            let idx = 0;
            function nextLine() {
                if (idx < lines.length) {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'message-text';
                    element.appendChild(lineDiv);
                    let i = 0;
                    function typing() {
                        if (i <= lines[idx].length) {
                            lineDiv.innerHTML = lines[idx].slice(0, i) + '<span style="border-right:2px solid #ff69b4"></span>';
                            i++;
                            setTimeout(typing, 40);
                        } else {
                            lineDiv.innerHTML = lines[idx]; // remove cursor
                            idx++;
                            setTimeout(nextLine, 500);
                        }
                    }
                    typing();
                } else {
                    // Hi·ªán n√∫t m·ªü qu√† sau khi ch·∫°y xong
                    const btn = document.getElementById('openGiftBtn');
                    if (btn) btn.style.display = 'inline-block';
                    if (done) done();
                }
            }
            nextLine();
        }


        function checkPassword() {
            if (display.value === '13072006') {
                calculatorScreen.style.display = 'none';
                birthdayScreen.style.display = 'block';

                // ·∫®n to√†n b·ªô n·ªôi dung b√™n trong birthdayScreen, ch·ªâ hi·ªán th∆∞ ƒë√≥ng
                document.querySelector('.birthday-title').style.display = 'none';
                document.querySelector('.date-special').style.display = 'none';
                document.getElementById('letterClosed').style.display = 'flex';
                document.getElementById('letterOpened').style.display = 'none';
                document.querySelector('.back-btn').style.display = 'none';

                setTimeout(() => {
                    createEnhancedFireworks();
                    playSuccessAnimation();
                }, 500);
            } else {
                // Enhanced shake effect
                display.style.animation = 'shake 0.6s ease-in-out';
                display.style.borderColor = '#ff4444';
                
                setTimeout(() => {
                    alert('üå∏ M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! H√£y th·ª≠ l·∫°i nh√©! üå∏');
                    clearDisplay();
                    display.style.animation = '';
                    display.style.borderColor = '';
                }, 600);
            }
        }

        // Kh·ªüi t·∫°o trang l·ªùi ch√∫c v·ªõi hi·ªáu ·ª©ng
        function initWishesPage() {
            createFireworksBackground();
            createFloatingHearts();
            
            // Th√™m s·ª± ki·ªán click cho thi·ªáp 3D tr√™n mobile
            const card3D = document.querySelector('.card-3d');
            if (card3D) {
                // S·ª± ki·ªán cho c·∫£ desktop v√† mobile
                card3D.addEventListener('click', function() {
                    this.classList.toggle('active');
                    // M·ªü th∆∞ ngay khi ch·∫°m v√†o
                    openLetter();
                });
                // X√ìA touchstart ƒë·ªÉ tr√°nh nh·∫•n gi·ªØ
                // card3D.addEventListener('touchstart', function(e) {
                //     e.preventDefault();
                //     this.classList.toggle('active');
                //     openLetter();
                // });
                // T·ª± ƒë·ªông ch·∫°y ch·ªØ sau 2 gi√¢y
                setTimeout(() => {
                    typeCardText();
                }, 2000);
            }
            
            setTimeout(() => {
                launchContinuousConfetti();
            }, 1000);
        }

        // Chuy·ªÉn sang gallery tr√°i tim thay v√¨ b·ª©c th∆∞
        function showLetter() {
            // T·∫°o hi·ªáu ·ª©ng fade out tr∆∞·ªõc khi chuy·ªÉn trang
            document.getElementById('wishesPage').style.transition = 'opacity 0.7s ease';
            document.getElementById('wishesPage').style.opacity = '0';
            setTimeout(() => {
                window.location.href = 'chucmung.html';
            }, 800);
        }

        // Success animation
        function playSuccessAnimation() {
            const cake = document.querySelector('.cake');
            if (cake) {
                cake.style.animation = 'none';
                cake.offsetHeight; // Trigger reflow
                cake.style.animation = 'cakeParty 1s ease-in-out 3';
            }
        }

        // Confetti function
        function launchConfetti() {
            for (let i = 0; i < 80; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = `hsl(${Math.random()*360},90%,60%)`;
                    confetti.style.animationDuration = (Math.random()*1.5+1.5) + 's';
                    confetti.style.width = confetti.style.height = (Math.random()*8+6) + 'px';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 2500);
                }, i*18);
            }
        }

        // Performance optimization: Pause animations when tab is not visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                particleSystem.pause();
                clearInterval(sparkleInterval);
                clearInterval(flowerInterval);
            } else {
                particleSystem.resume();
            }
        });

        // Intersection Observer for performance
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '50px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animationPlayState = 'running';
                } else {
                    entry.target.style.animationPlayState = 'paused';
                }
            });
        }, observerOptions);

        // Observe animated elements
        setTimeout(() => {
            document.querySelectorAll('.sparkle, .flower').forEach(el => {
                observer.observe(el);
            });
        }, 1000);

        // Auto-focus display
        display.focus();

        // Hi·ªáu ·ª©ng b√≥ng b√≥ng bay - Gi·∫£m t·∫ßn su·∫•t ƒë·ªÉ tr√°nh rung l·∫Øc
        function createBubble() {
            const bubbles = document.getElementById('bubbles');
            if (!bubbles) return;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            // K√≠ch th∆∞·ªõc ng·∫´u nhi√™n
            const size = Math.random() * 40 + 30;
            bubble.style.width = size + 'px';
            bubble.style.height = size + 'px';
            // V·ªã tr√≠ ngang ng·∫´u nhi√™n
            bubble.style.left = Math.random() * 100 + 'vw';
            // Th·ªùi gian bay ng·∫´u nhi√™n
            bubble.style.animationDuration = (6 + Math.random() * 4) + 's';
            bubbles.appendChild(bubble);
            setTimeout(() => {
                bubble.remove();
            }, 9000);
        }
        // Gi·∫£m t·∫ßn su·∫•t t·ª´ 700ms xu·ªëng 2000ms
        setInterval(createBubble, 2000);
        for (let i = 0; i < 5; i++) createBubble(); // Gi·∫£m t·ª´ 10 xu·ªëng 5

        // Hi·ªáu ·ª©ng tr√°i tim nh·ªè bay - Gi·∫£m t·∫ßn su·∫•t ƒë·ªÉ tr√°nh rung l·∫Øc
        function createBgHeart() {
            const bgHearts = document.getElementById('bgHearts');
            if (!bgHearts) return;
            const heart = document.createElement('div');
            heart.className = 'bg-heart';
            // Ch·ªçn ng·∫´u nhi√™n 1 trong 3 tr√°i tim
            const heartTypes = ['üíñ', 'üíó', 'üíû'];
            heart.innerHTML = heartTypes[Math.floor(Math.random() * heartTypes.length)];
            // K√≠ch th∆∞·ªõc ng·∫´u nhi√™n
            const size = Math.random() * 18 + 22;
            heart.style.fontSize = size + 'px';
            // V·ªã tr√≠ ngang ng·∫´u nhi√™n
            heart.style.left = Math.random() * 100 + 'vw';
            // Th·ªùi gian bay ng·∫´u nhi√™n
            heart.style.animationDuration = (5 + Math.random() * 4) + 's';
            bgHearts.appendChild(heart);
            setTimeout(() => {
                heart.remove();
            }, 9000);
        }
        // Gi·∫£m t·∫ßn su·∫•t t·ª´ 1200ms xu·ªëng 3000ms
        setInterval(createBgHeart, 3000);
        for (let i = 0; i < 3; i++) createBgHeart(); // Gi·∫£m t·ª´ 6 xu·ªëng 3

        function openLetter() {
            document.getElementById('letterClosed').style.display = 'none';
            const opened = document.getElementById('letterOpened');
            opened.style.display = 'flex';
            // Hi·ªáu ·ª©ng ch·ªØ ch·∫°y t·ª´ng d√≤ng
            const messageEl = opened.querySelector('.birthday-message');
            typeBirthdayLines(birthdayLines, messageEl, function(){});
        }

        // S·ª≠a l·∫°i checkPassword ƒë·ªÉ ch·ªâ hi·ªán b·ª©c th∆∞, ch∆∞a hi·ªán n·ªôi dung
        function checkPassword() {
            if (display.value === '13072006') {
                calculatorScreen.style.display = 'none';
                birthdayScreen.style.display = 'block';

                // ·∫®n to√†n b·ªô n·ªôi dung b√™n trong birthdayScreen, ch·ªâ hi·ªán th∆∞ ƒë√≥ng
                document.querySelector('.birthday-title').style.display = 'none';
                document.querySelector('.date-special').style.display = 'none';
                document.getElementById('letterClosed').style.display = 'flex';
                document.getElementById('letterOpened').style.display = 'none';
                document.querySelector('.back-btn').style.display = 'none';

                setTimeout(() => {
                    createEnhancedFireworks();
                    playSuccessAnimation();
                }, 500);
            } else {
                // Enhanced shake effect
                display.style.animation = 'shake 0.6s ease-in-out';
                display.style.borderColor = '#ff4444';
                
                setTimeout(() => {
                    alert('üå∏ M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! H√£y th·ª≠ l·∫°i nh√©! üå∏');
                    clearDisplay();
                    display.style.animation = '';
                    display.style.borderColor = '';
                }, 600);
            }
        }


